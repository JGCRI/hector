<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Units values (`unitvals` and `fluxpools`) • hector</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Units values (`unitvals` and `fluxpools`)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">3.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/manual.html">Manual</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-getting-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Getting Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-getting-started">
<li><a class="dropdown-item" href="../articles/BuildHector.html">Building Hector</a></li>
    <li><a class="dropdown-item" href="../articles/hector.html">Intro to Hector R interface</a></li>
    <li><a class="dropdown-item" href="../articles/Hector-Wider-World.html">Documentation manuscripts &amp; tutorials</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/hector.html">Example: Basic run and simple sensitivity anlaysis</a></li>
    <li><a class="dropdown-item" href="../articles/ex_hector_apply.html">Example: Using Hector to solve for an emissions pathway</a></li>
    <li><a class="dropdown-item" href="../articles/ex_multiple-biomes.html">Example: Running Hector with multiple biomes</a></li>
    <li><a class="dropdown-item" href="../articles/ex_carbon_tracking.html">Example: Carbon tracking with Hector</a></li>
    <li><a class="dropdown-item" href="../articles/ex_land_ocean_warming.html">Example: Changing Hector's land ocean warming ratio parameter</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JGCRI/hector"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Units values (`unitvals` and `fluxpools`)</h1>
            <h3 data-toc-skip class="subtitle">C++</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JGCRI/hector/blob/main/vignettes/articles/Unitvals.Rmd" class="external-link"><code>vignettes/articles/Unitvals.Rmd</code></a></small>
      <div class="d-none name"><code>Unitvals.Rmd</code></div>
    </div>

    
    
<p>Hector both <em>allows</em> (internally to each component, and when
reading inputs) and <em>requires</em> (passing data between components,
and writing outputs) values to have associated <strong>units</strong>.
The internal unit system is simple, not providing <a href="http://www.boost.org/doc/libs/1_57_0/doc/html/boost_units.html" class="external-link">unit
conversion</a> for example, but also lightweight and easy. Our use of
units is prompted primarily by safety – to avoid the “Mars Climate
Orbiter” <a href="http://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure" class="external-link">problem</a>
of the mismatched unit – as well as having easy-to-interpret
outputs.</p>
<p>The internal C++ type is called <code>unitval</code>, and its code is
located in <code>inst/include/unitval.hpp</code>.<br>
(There is also a restricted type of <code>unitval</code> called a
<code>fluxpool</code> that allows only non-negative values.)</p>
<div class="section level2">
<h2 id="creating-a-variable-with-associated-unit">Creating a variable with associated unit<a class="anchor" aria-label="anchor" href="#creating-a-variable-with-associated-unit"></a>
</h2>
<p>Two ways to create a <code>unitval</code>:</p>
<pre><code>unitval x(1, U_PGC);  # x now holds 1 petagram of carbon
unitval y;
y.set(2, U_CO2_PPMV);</code></pre>
</div>
<div class="section level2">
<h2 id="doing-math">Doing math<a class="anchor" aria-label="anchor" href="#doing-math"></a>
</h2>
<p>The <code>unitval</code> class supports basic mathematical
operations.</p>
<pre><code># assume that y and z are already defined unitvals
unitval x = y + z;  # y and z must have identical units or an error is thrown
unitval x = y * 2.0;  # multiplying by a constant always works</code></pre>
</div>
<div class="section level2">
<h2 id="extracting-a-unitval-value">Extracting a <code>unitval</code> value<a class="anchor" aria-label="anchor" href="#extracting-a-unitval-value"></a>
</h2>
<p>Internally within components, we often simply want to work with
numbers, extracting them from <code>unitval</code> objects. This is
straightforward, but first we have to ‘prove’ that we know the correct
units:</p>
<pre><code>double x = y.value(U_PGC); # we assert that y's units are petagrams C</code></pre>
<p>The core will throw an error if we get the results of <code>y</code>
wrong.</p>
</div>
<div class="section level2">
<h2 id="when-is-unitval-required">When is <code>unitval</code> required?<a class="anchor" aria-label="anchor" href="#when-is-unitval-required"></a>
</h2>
<p>Using <code>unitvals</code> <em>within</em> a component is optional,
but it’s required when passing data <em>between</em> components. This
falls into three categories:</p>
<ul>
<li>Querying the core for data. Read more about Hector’s internal <a href="InternalDataPassing.html">data passing</a>.</li>
<li>Responding to a query for data.</li>
<li>Output. Read more about Hector’s <a href="OutputVisitors.html">output visitors</a>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="fluxpool-values">Fluxpool values<a class="anchor" aria-label="anchor" href="#fluxpool-values"></a>
</h2>
<p>Hector v3 introduces a new internal unit class:
<code>fluxpool</code>, a subclass of <code>unitval</code> defined in
<code>inst/include/fluxpool.hpp</code>. This class imposes a
restriction: values may only be zero of positive, and any negative
value, or operation that results in a negative value, throws an error.
This is used for carbon fluxes and pools that may <em>not</em> be
negative; why this is so for pools is hopefully obvious, and fluxes we
think of as possibly being ‘negative’ (e.g., net biome production) are
in fact the difference between two nominally positive fluxes.</p>
<p>Currently fluxpools may not be passed between model components.</p>
<p>Finally, the fluxpool class is where carbon tracking is implemented;
see the <a href="ex_carbon_tracking.html">relevant exmaple</a>.</p>
</div>
<div class="section level2">
<h2 id="missing-values">Missing values<a class="anchor" aria-label="anchor" href="#missing-values"></a>
</h2>
<p>Briefly, when you need to return a missing value, use the
<code>MISSING_FLOAT</code> macro defined in
<code>inst/include/unitval.hpp</code>. This macro will return
<code>NA_REAL</code> (from <code>Rcpp</code>) if Hector is compiled as
an R package (technically, if the <code>USE_RCPP</code> macro is
defined) and <code>NAN</code> (from <code>std</code>) otherwise.</p>
<p>Why this complexity?<br>
R (and, by extension, Rcpp) distinguishes between two kinds of
“placeholder” numeric values: A <em>missing</em> value
(<code>NA_real_</code> in R; often abbreviated to <code>NA</code>)
represents an unobserved value; for instance, if you take annual
observations from 1990 to 2000 but failed to make a measurement in 1996.
On the other hand, <em>not a number</em> (<code>NaN</code>) represents
the result of an invalid mathematical operation, such as taking the
square root of a negative number.</p>
<p>Both of these values propagate through any calculations in which they
are involved, both in R and C++, and can be detected and removed by R’s
<code><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na()</a></code> and similar functions. (Note that the R function
<code><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.nan()</a></code> can be used to check specifically for
<code>NaN</code> values – <code>is.nan(NaN) =&gt; TRUE</code>, but
<code>is.nan(NA) =&gt; FALSE</code>). However, because they mean
fundamentally different things (and suggest different errors), we try to
preserve this distinction if we can.</p>
<hr>
<p>See also <a href="units.html">notes on hector units</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kalyn Dorheim, Ben Bond-Lamberty.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
