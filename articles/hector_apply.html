<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example: solving for an emissions pathway • hector</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example: solving for an emissions pathway">
<meta property="og:description" content="hector">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hector</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/manual/index.html">Manual</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro-to-hector.html">A tour of the Hector R interface</a>
    </li>
    <li>
      <a href="../articles/hector_apply.html">Example: Using Hector to solve for an emissions pathway</a>
    </li>
    <li>
      <a href="../articles/multiple-biomes.html">Example: Running Hector with multiple biomes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JGCRI/hector" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="hector_apply_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example: solving for an emissions pathway</h1>
                        <h4 data-toc-skip class="author">Robert Link</h4>
            
            <h4 data-toc-skip class="date">2018-10-17</h4>
      
      
      <div class="hidden name"><code>hector_apply.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial shows how to use the Hector climate model in R to answer a simple science question. In this case, we’ll be looking at solving for the methane emissions required over time to produce a constant atmospheric methane concentration from 2000 through 2100.</p>
<p>To run this experiment, you will need to have the <code>nleqslv</code> package installed. This package will be used to generate successive guesses in the search for an emissions pathway that produces the target concentration.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>The <code>nleqslv</code> package requires us to supply a function that takes a vector of inputs (i.e., emissions by year) and produces a vector of outputs that are the discrepancies between the Hector output and the target concentrations. In order to create such a function we will need to set up an interface to Hector. Since all of our calculations are going to involve years 2000 and beyond, we will run up through 1999.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">'ggplot2'</a></span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning in register(): Can't find generic `scale_type` in package ggplot2 to</span>
<span class="co">## register S3 method.</span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">'hector'</span><span class="op">)</span>
<span class="va">hector_inifile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'input'</span>, package<span class="op">=</span><span class="st">'hector'</span><span class="op">)</span>, <span class="st">'hector_rcp60.ini'</span><span class="op">)</span>
<span class="va">hcore</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newcore.html">newcore</a></span><span class="op">(</span><span class="va">hector_inifile</span>, suppresslogging<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">1999</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Hector core: unnamed hector core</span>
<span class="co">## Start date:  1745</span>
<span class="co">## End date:    2300</span>
<span class="co">## Current date:    1999</span>
<span class="co">## Input file:  /Users/runner/work/_temp/Library/hector/input/hector_rcp60.ini</span></code></pre>
<p>Our target function will take a vector of emission values as input and return a vector of discrepancies between the hector outputs and the target output. We’ll make the target concentration value 1820 ppbv CH<span class="math inline">\(_4\)</span> (a bit higher than the year 2000 value in the baseline scenario).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">emiss</span><span class="op">)</span>
<span class="op">{</span>
    <span class="fu"><a href="../reference/setvar.html">setvar</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2100</span>, <span class="fu"><a href="../reference/methane.html">EMISSIONS_CH4</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">emiss</span>, <span class="st">"Tg CH4"</span><span class="op">)</span>
    <span class="fu"><a href="../reference/reset.html">reset</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">1999</span><span class="op">)</span>
    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">2100</span><span class="op">)</span>
    <span class="va">hout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fetchvars.html">fetchvars</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2100</span>, <span class="fu"><a href="../reference/methane.html">ATMOSPHERIC_CH4</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
    <span class="co">## return the difference between the target of 1820 (constant) and the actual</span>
    <span class="va">hout</span><span class="op">$</span><span class="va">value</span> <span class="op">-</span> <span class="fl">1820</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="solve-for-the-target-emissions">Solve for the target emissions<a class="anchor" aria-label="anchor" href="#solve-for-the-target-emissions"></a>
</h2>
<p>To solve for the target emissions we just pass the target function to <code>nleqslv</code>. We also need an initial guess for the emissions. It doesn’t really matter what the guess is, so long as it isn’t something so large that it will cause the model to fail outright. We will use a constant 300 Tg CH<span class="math inline">\(_4\)</span> as the initial guess.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">300.0</span>, times<span class="op">=</span><span class="fl">101</span><span class="op">)</span>  <span class="co"># 2000:2001 includes both endpoints</span>
<span class="va">slv</span> <span class="op">&lt;-</span> <span class="fu">nleqslv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nleqslv/man/nleqslv.html" class="external-link">nleqslv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">f</span>, method<span class="op">=</span><span class="st">"Broyden"</span><span class="op">)</span></code></pre></div>
<p>We should check to see that the algorithm really converged. The discrepancy values from the last iteration are stored in the <code>fvec</code> entry.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">slv</span><span class="op">$</span><span class="va">fvec</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 4.381491e-09</span></code></pre>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>The convergence looks ok, so let’s plot the results:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"> <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2100</span>,
            value <span class="op">=</span> <span class="va">slv</span><span class="op">[[</span><span class="st">'x'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

 <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Emissions (Tg CH4)"</span>, x <span class="op">=</span> <span class="st">'year'</span><span class="op">)</span></code></pre></div>
<p><img src="hector_apply_files/figure-html/plt-1.png" width="700"></p>
<p>The concentration target of 1820 ppbv CH<span class="math inline">\(_4\)</span> that we specified in 2000 is a bit of a jump from what was in the scenario we based our run on (the original was about 1811 ppbv), so we have a small spike in emissions in 2000. After that the emissions settle down into something smoother.</p>
<p>Once we’re done with our Hector instance, we need to make sure to shut it down, so that the memory it is using will be freed.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/shutdown.html">shutdown</a></span><span class="op">(</span><span class="va">hcore</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Hector core (INACTIVE)</span></code></pre>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This simple example shows the kind of thing you can do by combining the Hector R interface with other packages available in R. It would be easy enough to add emissions for other gasses or work in terms of forcing or temperature. Likewise, instead of solving for an equilibrium you could minimize or maximize some function of the emissions (using the <code>optim</code> function), or run one of the many Monte Carlo packages that are available in R.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Robert Link, Kalyn Dorheim.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
