<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Solving for an emissions pathway • hector</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Solving for an emissions pathway">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">3.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/manual.html">Manual</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-getting-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Getting Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-getting-started">
<li><a class="dropdown-item" href="../articles/BuildHector.html">Building Hector</a></li>
    <li><a class="dropdown-item" href="../articles/hector.html">Intro to Hector R interface</a></li>
    <li><a class="dropdown-item" href="../articles/Hector-Wider-World.html">Documentation manuscripts &amp; tutorials</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/hector.html">Example: Basic run and simple sensitivity anlaysis</a></li>
    <li><a class="dropdown-item" href="../articles/ex_hector_apply.html">Example: Using Hector to solve for an emissions pathway</a></li>
    <li><a class="dropdown-item" href="../articles/ex_multiple-biomes.html">Example: Running Hector with multiple biomes</a></li>
    <li><a class="dropdown-item" href="../articles/ex_carbon_tracking.html">Example: Carbon tracking with Hector</a></li>
    <li><a class="dropdown-item" href="../articles/ex_land_ocean_warming.html">Example: Changing Hector's land ocean warming ratio parameter</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JGCRI/hector"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Solving for an emissions pathway</h1>
                        <h4 data-toc-skip class="author">Robert
Link</h4>
            
            <h4 data-toc-skip class="date">2018-10-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JGCRI/hector/blob/main/vignettes/articles/ex_hector_apply.Rmd" class="external-link"><code>vignettes/articles/ex_hector_apply.Rmd</code></a></small>
      <div class="d-none name"><code>ex_hector_apply.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial shows how to use the Hector climate model in R to
answer a simple science question. In this case, we’ll be looking at
solving for the methane emissions required over time to produce a
constant atmospheric methane concentration from 2000 through 2100.</p>
<p>To run this experiment, you will need to have the
<code>nleqslv</code> package installed. This package will be used to
generate successive guesses in the search for an emissions pathway that
produces the target concentration.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>The <code>nleqslv</code> package requires us to supply a function
that takes a vector of inputs (i.e., emissions by year) and produces a
vector of outputs that are the discrepancies between the Hector output
and the target concentrations. In order to create such a function, we
will need to set up an interface to Hector. Since all of our
calculations are going to involve the years 2000 and beyond, we will run
up through 1999.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JGCRI/hector" class="external-link">hector</a></span><span class="op">)</span></span>
<span><span class="va">hector_inifile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"input"</span>, package <span class="op">=</span> <span class="st">"hector"</span><span class="op">)</span>, <span class="st">"hector_ssp245.ini"</span><span class="op">)</span></span>
<span><span class="va">hcore</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newcore.html">newcore</a></span><span class="op">(</span><span class="va">hector_inifile</span>, suppresslogging <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">1999</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Hector core: Unnamed Hector core</span></span>
<span><span class="co">## Start date:  1745</span></span>
<span><span class="co">## End date:    2300</span></span>
<span><span class="co">## Current date:    1999</span></span>
<span><span class="co">## Input file:  /home/runner/work/_temp/Library/hector/input/hector_ssp245.ini</span></span></code></pre>
<p>Our target function will take a vector of emission values as input
and return a vector of discrepancies between the Hector outputs and the
target output. We’ll make the target concentration value 1820 ppbv
CH<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi></mi><mn>4</mn></msub><annotation encoding="application/x-tex">_4</annotation></semantics></math>
(a bit higher than the year 2000 value in the baseline scenario).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">emiss</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/setvar.html">setvar</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2100</span>, <span class="fu"><a href="../reference/methane.html">EMISSIONS_CH4</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">emiss</span>, <span class="st">"Tg CH4"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/reset.html">reset</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">1999</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">2100</span><span class="op">)</span></span>
<span>    <span class="va">hout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fetchvars.html">fetchvars</a></span><span class="op">(</span><span class="va">hcore</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2100</span>, <span class="fu"><a href="../reference/methane.html">CONCENTRATIONS_CH4</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co">## return the difference between the target of 1820 (constant) and the actual</span></span>
<span>    <span class="va">hout</span><span class="op">$</span><span class="va">value</span> <span class="op">-</span> <span class="fl">1820</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="solve-for-the-target-emissions">Solve for the target emissions<a class="anchor" aria-label="anchor" href="#solve-for-the-target-emissions"></a>
</h2>
<p>To solve for the target emissions we just pass the target function to
<code>nleqslv</code>. We also need an initial guess for the emissions.
It doesn’t really matter what the guess is, so long as it isn’t
something so large that it will cause the model to fail outright. We
will use a constant 300 Tg
CH<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi></mi><mn>4</mn></msub><annotation encoding="application/x-tex">_4</annotation></semantics></math>
as the initial guess.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">300.0</span>, times <span class="op">=</span> <span class="fl">101</span><span class="op">)</span>  <span class="co"># 2000:2001 includes both endpoints</span></span>
<span><span class="va">slv</span> <span class="op">&lt;-</span> <span class="fu">nleqslv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nleqslv/man/nleqslv.html" class="external-link">nleqslv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">f</span>, method <span class="op">=</span> <span class="st">"Broyden"</span><span class="op">)</span></span></code></pre></div>
<p>We should check to see if the algorithm really converged. The
discrepancy values from the last iteration are stored in the
<code>fvec</code> entry.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">slv</span><span class="op">$</span><span class="va">fvec</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.116132e-08</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>The convergence looks okay, so let’s plot the results:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2100</span>,</span>
<span>            value <span class="op">=</span> <span class="va">slv</span><span class="op">[[</span><span class="st">"x"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"year"</span>, y <span class="op">=</span> <span class="st">"Emissions (Tg CH4)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ex_hector_apply_files/figure-html/plt-1.png" width="700"></p>
<p>The concentration target of 1820 ppbv
CH<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi></mi><mn>4</mn></msub><annotation encoding="application/x-tex">_4</annotation></semantics></math>
that we specified in 2000 is a bit of a jump from what was in the
scenario we based our run on (the original was about 1811 ppbv), so we
have a small spike in emissions in 2000. After that, the emissions
settle down into something smoother.</p>
<p>Once we’re done with our Hector instance, we need to make sure to
shut it down, so that the memory it is using will be freed.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/shutdown.html">shutdown</a></span><span class="op">(</span><span class="va">hcore</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Hector core (INACTIVE)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This simple example shows the kind of thing you can do by combining
the Hector R interface with other packages available in R. It would be
easy enough to add emissions for other gasses or work in terms of
forcing or temperature. Likewise, instead of solving for an equilibrium
you could minimize or maximize some function of the emissions (using the
<code>optim</code> function), or run one of the many Monte Carlo
packages that are available in R.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kalyn Dorheim, Ben Bond-Lamberty.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
