---
title: Terrestrial C cycle
---

Contents:

- [Scientific basis](#simplenbox-science) behind the terrestrial C cycle
- [Implementation details](#simplenbox-implementation)

# Science {#simplenbox-science}

Hector's land C sink is divided into three pools: vegetation ($C_v$), detritus ($C_d$), and soil ($C_s$).
These sinks are global by default, but they can be divided into $n$ "biomes" with unique parameters and initial pool sizes.

The total C flux from atmosphere to land at time $t$ ($F_{L}(t)$) is the net of C sequestration by photosynthesis (net primary productivity, $NPP_i(t)$) and C release by heterotrophic respiration ($RH(t)$), summed across each biome $i$:

$$ F_{L}(t) = \sum_{i=1}^{n} \left( NPP_i(t) - RH_i(t) \right) $$

NPP is calculated as the product of a user-specified pre-industrial value ($NPP_0$, default is 50 PgC/year) and a CO~2~ fertilization multiplier ($f(C_{atm}, \beta)$), which in turn is a function of the current atmospheric CO~2~ concentration ($C_{atm}$), the initial ("pre-industrial") CO~2~ concentration ($C_0$), and biome-specific CO~2~ fertilization parameter $\beta_i$ (default = 0.36):

$$ NPP_i(t) = NPP_{0,i} \times f(C_{atm}, \beta_i) $$
$$ f(C_{atm}, \beta_i) = 1 + \beta_i \left( log(\frac{C_{atm}}{C_0})\right) $$

Heterotrophic respiration occurs in soil ($RH_s(t)$) and detritus ($RH_d(t))$) as a function of biome-specific atmospheric temperature anomaly ($T_i$, calculated as the global atmospheric temperature anomaly scaled by a biome-specific warming factor $\delta$) and the size of the current soil and detritus C pools ($C_s$ and $C_d$, respectively).

$$ T_i(t) = \delta \times T_G(t) $$
$$ RH_s = 0.02 C_s Q_{10}^{T_{i}(t) / 10}$$
$$ RH_d = 0.25 C_d Q_{10}^{T_{i}(t) / 10}$$

Note that the fractions of soil and detritus C available to respiration are hard-coded at 0.02 and 0.25, respectively.

In each biome at each time step, the vegetation pools change as follows (biome, $i$ and time, $t$ subscripts omitted for clarity):
C gain from NPP is distributed to vegetation, detritus, and soil according to fractionation parameters $f_{nv}$, $f_{nd}$, and $f_{ns}$, respectively.
Similarly, each pool bears a fraction of the total C loss from land-use change ($F_{LC}$), again according to fractions $f_{lv}$, $f_{ld}$, and $f_{ls}$.
The detritus and soil pools also lose C via heterotrophic respiration ($RH_d$ and $RH_s$, respectively).
Finally, a fixed fraction of vegetation C is transferred to detritus as litterfall ($f_{vd}$), and a fraction of both vegetation ($f_{vs}$) and detritus ($f_{ds}$) are transferred to soil via decomposition.

$$ \frac{dC_v}{dt} = NPP\, f_{nv} - C_v (f_{vd} + f_{vs}) - F_{LC} f_{lv} $$
$$ \frac{dC_d}{dt} = NPP\, f_{nd} + C_v f_{vd} - C_d f_{ds} - RH_d - F_{LC} f_{ld} $$
$$ \frac{dC_s}{dt} = NPP\, f_{ns} + C_v f_{vs} - C_d f_{ds} - RH_s - F_{LC} f_{ls} $$

The entire terrestrial C cycle is summarized in the following diagram:

```{r terrestrial-c-diagram, echo = FALSE, fig.cap = terrestrial_c_cap}
terrestrial_c_cap <- paste(
  "Summary of terrestrial C cycle in Hector."
)
knitr::include_graphics("hector_terrestrial_c.svg")
# Edit this diagram at:
# https://www.lucidchart.com/invitations/accept/895610d2-ee0e-453f-a5fa-2334171e5b54
# (Free LucidChart account required.)
```

# Implementation {#simplenbox-implementation}

The state of the global C cycle in Hector is defined by a length 6 vector `c`, which describes the amount of C (in Pg C) in the atmosphere (0), vegetation (1), detritus (2), soil (3), ocean (4), and "Earth" (5) at the current time step.
At each Hector time step, `c` is solved by the `CarbonCycleSolver::run()` function (defined in [`src/carbon-cycle-solver.cpp`][solver]) in the following general steps:

1. Retrieve the current estimates of various pools from variables defined by the C cycle model and assign them to the relevant parts of `c` (`getCValues`).
2. Integrate from the beginning of the time step using updated slow parameters (`slowparameval`).
3. Solve the ordinary differential equations associated with the C cycle model based on its time derivatives (defined in `calcderivs`).
4. Re-calculate C cycle model internal variables based on the solved values of `c` (`stashCValues`).
5. Record the model state (`record_state`).

These steps are described in more detail below.
The complete code for the terrestrial C cycle lives in [`src/simpleNbox.cpp`][cpp] file (with associated headers in [`inst/include/simpleNbox.hpp`][hpp]).

[solver]: https://github.com/JGCRI/hector/blob/master/src/carbon-cycle-solver.cpp
[cpp]: https://github.com/jgcri/hector/blob/master/src/simpleNbox.cpp
[hpp]: https://github.com/JGCRI/hector/blob/master/inst/include/simpleNbox.hpp

## Setting the `c` vector (`getCValues`)

This function sets the values of the `c` vector to the corresponding state variables in the C cycle model.
The atmospheric C pool for the current time step is defined by `atmos_c`, which is always a scalar unit quantity (because CO~2~ is assumed to be well-mixed in the atmosphere).
Vegetation, detritus, and soil pools at the current time step are stored in `veg_c`, `detritus_c`, and `soil_c`, respectively.
These are vector quantities ("stringmaps"), with one value for each biome (the default biome name is "global"), so the value stored in the corresponding slot in `c` is the sum across all biomes.
The ocean C pool is retrieved by a call to the current ocean model's `getCValues` function.
(NOTE: This means that `simpleNBox` model depends on the existence of an ocean C cycle model.)
Finally, the "Earth" C pool is stored in `earth_c`, which is also a scalar unit quantity.
All of these variables have are in units Pg C.

## Slow parameter evaluation (`slowparameval`)

## C cycle derivatives (`calcderivs`)

## Storing the results (`stashCValues`)

## Recording the state (`record_state`)


- `newcore()`
    - `SimpleNbox.init()`
        - Set initial values.
        - Register inputs and capabilities.
    - `SimpleNbox.setData()` -- Set values from `[SimpleNbox]` section of INI file.
    - `SimpleNbox.prepareToRun()`
        - Check that pools and parameters are correct size.
        - Point to ocean model
        - Check size of `Ftalbedo`
        - Set atmospheric CO~2~ concentration (`Ca`) and pool size (`atmos_c`) to initial value (`C0` / `coinit`)
        - Check values of `beta` and `q10_rh`
- `reset(time = 0) --> SimpleNbox.reset()`
    - Set current C values (`earth_c`, `atmos_c`, `Ca`, `veg_c`, `detritus_c`, `soil_c`) and a few additional variables (`residual`, `tempferts`, `tempfertd`) from their respective time-series variables (`earth_c_ts`, `atmos_c_ts`, `veg_c_tv`, etc.)
    - Calculate the CO~2~ fertilization effect (`co2fert`) for each biome
    - Truncate all time-series to the current `time`
    - Set `tcurrent` to `time`
    - If using spin-up and `time` is less than the start date, re-run spin-up (`prepareToRun()`) -- `run_spinup()`
        - `SimpleNbox.run_spinup()` -- Just runs `SimpleNbox.sanitychecks()`
        - `SimpleNbox.sanitychecks()`
            - Check that `(atmos|veg|detritus|soil)_c` pools, and `npp_flux0`, `C0`, and `Ca` are all greater than zero
            - Check that all fractions (`f_nppv`, `f_nppd`, `f_litterd`) are greater than zero and sum to 1
        - `CarbonCycleSolver.run_spinup()`
            - If this is the first time, set global "flat" C pool variable (`c`) to zero.
            - `SimpleNbox.getCValues()` -- Set `c_old`
                - Transfer pools from variables (`atmos_c`, `veg_c`, ...) to `c`
            - `SimpleNbox.run()`
                - Run `sanitychecks` (see above)
                - Set the `Tgav_record` time-series to the current value
            - `CarbonCycleSolver.run()`
                - `getCValues()` -- Set the flat `c` array to the current values
                - `SimpleNbox.slowparameval()`
                    - Set the current `Ca` to atmospheric `c` value
                    - Calculate the CO~2~ fertilization effect (`co2fert`)
                    - Calculate the temperature anoamly (`Tgav`)
                    - Get the last value of `tempferts`
                    - If in spinup, continue. Otherwise, calculate RH for detritus and soil based on Q10 and `Tgav`
                - Solve the ODE for the C cycle
                - `SimpleNbox.stashCValues()` -- Transfer ODE pools back to model pools
                    - Pass values from `c` to `atmos_c`, `veg_c`, `detritus_c`, etc. Apportion to biomes according to fraction of NPP and RH in that biome.
            - Use `getCValues` to set `c_new` (as above), and take the difference
            - `SimpleNbox.record_state()` -- Store the current C cycle state.
                - Set time-series variables (e.g. `earth_c_ts`, `atmos_c_ts`, `veg_c_tv`, etc.) to their current values 
                - Tell the ocean model to record its state
- `run()`

## Setting values {#simplenbox-setdata}

The following values related to the terrestrial C cycle can be set via `setData`.


| Description                        | Unit       | C++ macro             | R function            | C++ variable    | Needs date | Biome-specific | Set | Get |
|------------------------------------|------------|-----------------------|-----------------------|-----------------|------------|----------------|-----|-----|
| Initial atmospheric CO~2~ pool     | PgC        | `D_ATMOSPHERIC_C`     | `ATMOSPHERIC_C()`     | `C0`            | No         | No             | Yes | Yes |
| Pre-industrial CO~2~ concentration | ppmv CO~2~ | `D_PREINDUSTRIAL_C02` | `PREINDUSTRIAL_CO2()` | `C0`            | No         | No             | Yes |     |
| Vegetation C pool                  | PgC        | `D_VEGC`              |                       | `veg_c`         | No         | Yes            | Yes |     |
| Detritus C pool                    | PgC        | `D_DETRITUSC`         |                       | `detritus_c`    | Yes        | Yes            | Yes |     |
| Soil C pool                        | PgC        | `D_SOILC`             |                       | `soil_c`        | No         | Yes            | Yes |     |
| Radiative forcing from albedo      | unitless   | `D_RF_T_ALBEDO`       | `RF_T_ALBEDO()`       | `Ftalbedo`      | Yes        | No             | Yes |     |
| Frac. NPP to vegetation            | unitless   | `D_F_NPPV`            | `F_NPPV()`            | `f_nppv`        | No         | No*            | Yes |     |
| Frac. NPP to detritus              | unitless   | `D_F_NPPD`            | `F_NPPD()`            | `f_nppd`        | No         | No*            | Yes |     |
| Frac. veg. C to litter             | unitless   | `D_F_LITTERD`         | `F_LITTERD()`         | `f_litterd`     | No         | No*            | Yes |     |
| Frac. LUC from vegetation          | unitless   | `D_F_LUCV`            | `F_LUCV()`            | `f_lucv`        | No         | No*            | Yes |     |
| Frac. LUC from detritus            | unitless   | `D_F_LUCD`            | `F_LUCD()`            | `f_lucd`        | No         | No*            | Yes |     |
| Initial NPP flux                   | PgC / year | `D_NPP_FLUX0`         |                       | `npp_flux0`     | No         | Yes            | Yes |     |
| Fossil fuel CO~2~ emissions        | PgC / year | `D_FFI_EMISSIONS`     | `FFI_EMISSIONS()`     | `ffiEmissions`  | Yes        | No             | Yes |     |
| LUC emissions                      | PgC / year | `D_LUC_EMISSIONS`     | `LUC_EMISSIONS()`     | `lucEmissions`  | Yes        | No             | Yes |     |
| Atmospheric CO2 constraint         | ppmv CO~2~ | `D_CA_CONSTRAIN`      |                       | `Ca_constrain`  | Yes        | No             | Yes |     |
| CO~2~ fertilization factor         | unitless   | `D_BETA`              | `BETA()`              | `beta`          | No         | Yes            | Yes |     |
| Biome warming multiplier           | unitless   | `D_WARMINGFACTOR`     |                       | `warmingfactor` | No         | Yes            | Yes |     |
| RH temperature sensitivity         | unitless   | `D_Q10_RH`            | `Q10_RH()`            | `q10_rh`        | No         | No*            | Yes |     |
