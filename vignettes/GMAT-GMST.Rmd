---
title: "Example: Calculating GMST from GMAT in Hector"
author: "Leeya Pressburger"
date: "2021-08-18"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Example: Carbon tracking with Hector}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The global mean surface temperature (GMST) is the average of the air temperature over land and the temperature at the surface of the ocean.^[Allen, M.R., O.P. Dube, W. Solecki, F. Aragón-Durand, W. Cramer, S. Humphreys, M. Kainuma, J. Kala, N. Mahowald, Y. Mulugetta, R. Perez, M. Wairiu, and K. Zickfeld, 2018: Framing and Context. In: Global Warming of 1.5°C. An IPCC Special Report on the impacts of global warming of 1.5°C above pre-industrial levels and related global greenhouse gas emission pathways, in the context of strengthening the global response to the threat of climate change, sustainable development, and efforts to eradicate poverty [Masson-Delmotte, V., P. Zhai, H.-O. Pörtner, D. Roberts, J. Skea, P.R. Shukla, A. Pirani, W. Moufouma-Okia, C. Péan, R. Pidcock, S. Connors, J.B.R. Matthews, Y. Chen, X. Zhou, M.I. Gomis, E. Lonnoy, T. Maycock, M. Tignor, and T. Waterfield (eds.)]. In Press.] This is a very useful metric for observing global temperature changes. However, Hector does not produce GMST as an output at this time. Hector does measure the global mean air temperature (GMAT), which we can use to back-calculate GMST. GMAT is the air temperature measured 2 meters above the ground and is what is presented in a daily weather report.^[Taylor, Jessica. "Analyzing Surface Air Temperatures by Latitude." NASA, 2018. https://mynasadata.larc.nasa.gov/mini-lesson/analyzing-surface-air-temperatures-latitude-student-activity] 

This vignette demonstrates how to set up the calculation between GMAT and GMST and how to plot results to observe differences over time. 

## Setup

Let's load the packages we will need and run a scenario.

``` {r hector.init}
library(hector)
library(ggplot2)

inifile <- file.path(system.file('input', package = 'hector'),
                     'hector_rcp45.ini')
core <- newcore(inifile)
run(core)
```


## Find GMST

GMST can be calculated from Hector outputs by computing a weighted sum of the land air and ocean surface temperatures using the following equation:

$ GMST = (land air temperature * fractional land area) + (ocean surface temperature * (1 - fractional land area)) $

In Hector, land air temperature is represented by `LAND_AIR_TEMP()` and `Tgav_land` while ocean surface temperature by `OCEAN_SURFACE_TEMP()` and `Tgav_ocean_ST`. These components stem from the variable `Tgav`, which is how Hector stores GMAT (along with `GLOBAL_TEMP()`.)

``` {r find.GMST}
flnd = 0.29;     # fractional land area, a constant in Hector

hector_output <- fetchvars(core, 1745:2300, vars = c(LAND_AIR_TEMP(), OCEAN_SURFACE_TEMP(), GLOBAL_TEMP()))

# Get the variables we want and corresponding years/value
output <- subset(hector_output, variable %in% c(LAND_AIR_TEMP(), OCEAN_SURFACE_TEMP()))
output <- subset(output, select = c(year, variable, value))

# Reorder data
output <- reshape(output, direction = "wide", idvar = "year", timevar = "variable")
names(output) <- gsub("value.", "", names(output))

# Conversion equation
output$Tgav_land <- output$Tgav_land * flnd
output$Tgav_ocean_ST <- output$Tgav_ocean_ST * (1 - flnd)
global_temp <- output$Tgav_land + output$Tgav_ocean_ST
global_temp <- as.data.frame(global_temp) 

# Organize final data, year and corresponding GMST
global_surface_temp <- cbind(output$year, global_temp)
names(global_surface_temp)[names(global_surface_temp) == "output$year"] <- "year"
names(global_surface_temp)[names(global_surface_temp) == "global_temp"] <- "value"

variable <- rep("GMST", times = 556)
variable <- as.data.frame(variable)
global_surface_temp <- cbind(global_surface_temp, variable)


# Rename Hector's variable for GMAT
global_air_temp <- subset(hector_output, variable == "Tgav")
global_air_temp <- subset(global_air_temp, select = c(variable, year, value))
global_air_temp$variable <- "GMAT"

```

## Plot 

The following plot shows GMST and GMAT over time. We see that recently, GMAT is higher than GMST as GMAT is responding more quickly to anthropogenic forcing than GMST. This makes sense as GMST accounts for heating over the oceans which warm more slowly than the atmosphere. 

``` {r plot}

data <- rbind(global_surface_temp, global_air_temp)

ggplot(data) + 
  geom_line(aes(year, value, color = variable)) + 
  theme_bw()  + 
  labs(y = expression(degree~'C'), 
       title = 'Comparison of Hector GMST and GMAT')

```


Then, to highlight the gap between the two temperatures, we can plot the difference.

``` {r plot.diff}

GMST_d <- subset(data, variable == "GMST")
GMAT_d <- subset(data, variable == "GMAT")

GMAT_d$variable <- "GMAT - GMST"
GMAT_d$value <- GMAT_d$value - GMST_d$value

ggplot(GMAT_d) + 
    geom_line(aes(year, value, color = variable)) + 
    theme_bw()  + 
  labs(y = expression(degree~'C'), 
       title = 'Differences in temperature over time')

```

## Conclusion

GMST allows for measuring global temperature fluctuations and is used to report global warming trends. While Hector does not directly return GMST as an output, it is straightforward to calculate the metric by using land and ocean surface temperatures. 

Remember to shut down the core.

``` {r shutdown}
shutdown(core)
```
