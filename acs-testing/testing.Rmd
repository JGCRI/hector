---
title: "plotting_and_hector_code"
author: "acs"
date: {r, Sys.Date()}
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

# Setup relevant libraries and directory for saving figs and data

```{r setup}
library(dplyr)
library(ggplot2)
library(tidyr)
library(zoo)
devtools::load_all('..')

data_dir <- 'data/'
ini_dir <- 'data/pic_hector_ini/climate/'
```



#  GCP data for NBP

## Read in and understand GCP data

This is true NBP: atmosphere to land, positive NBP = a sink

```{r}
# load the file passed from Dawn
gcp_data_dawn <- read.csv(paste0(data_dir, "nbp_gcp.csv"))

# Load the file pulled directly from GCP:
read.csv(paste0(data_dir,'Global_Carbon_Budget_2022v1p0_historical_co2_tab.csv'), stringsAsFactors = F) %>%
  select(year=Year, e_luc=land.use.change.emissions, s_land = land.sink, Units) %>%
  tidyr::replace_na(list(e_luc=0)) %>%
  # If we want to sum e_luc + s_land, uncomment from the `gather` to `ungroup` 
  # calls here and comment out the `mutate`:
  # gather(reporting_id, value, -year, -Units) %>%
  # group_by(year, Units) %>%
  # summarize(nbp = -sum(value, na.rm=T)) %>%
  # ungroup %>%
  # Following slide 56 of GCP_data/papers/GCP_CarbonBudget_2023_slides_v1.0-2-Alissa-Haward.pdf
  mutate(nbp = (s_land - e_luc)) ->
  gcp_data
```

### Check if GCP data and Dawn's agree

Check if `nbp = (s_land-e_luc)` from the raw GCP download agrees
 with file from Dawn. Note Dawn's file did `-(s_land-e_luc)` to have things
 in the land to atmosphere direction instead, and compare with offline model 
 outputs directly. so  have to do minus a minus

```{r}

print("Difference to Dawn's file:")
print(max(abs(gcp_data$nbp - -gcp_data_dawn$nbp)))
```

## Proceed with GCP data

Label data and convert units

```{r}

# Label data and convert units
gcp_data$scenario <- "1. Global Carbon Project"
gcp_data$nbp_raw <- gcp_data$nbp*1000
gcp_data$nbp <- zoo::rollmean(gcp_data$nbp_raw,k=10, align='right', fill= NA)

gcp_data %>% 
    filter(year >=1970)
```

# compare hector NBP with GCP

```{r}
#comparison with GCP

# package scenario
rcp <- "ssp245"
scenario_file <- paste0("input/hector_",rcp,".ini")
ini_file245 <- system.file(scenario_file, package="hector") 
#### QUESTION - is this right hector package if did devtools::load_all
#### ANSWER: yes, because added different ini to inst/input directory and after
####         devtools::load_all(..) that new ini is then accessible.

core245 <- hector::newcore(ini_file245, suppresslogging = FALSE, name='245')
hector::run(core245,runtodate = 2100)

out <- hector::fetchvars(core245, dates=1746:2100, vars=c(hector::NBP()))


```




# LUC emissions received by Hector

```{r}
gcam_emiss <- read.csv('/Users/snyd535/Documents/GitHub/hector/inst/input/gcam_emissions.csv', skip =4)

ggplot(gcam_emiss) +
    geom_line(mapping = aes(x=Date, y=luc_emissions))
```

```{r}
library(rgcam)

get_gcam_luc_emissR <- function(db_name="database_basexdb", gcam_dir, scenario,
                                read_from_file=FALSE,
                                filename="data/gcam_land_alloc.csv"){
  
  if (read_from_file) {
    gcam_land_alloc <- read.csv2(file=filename,header=TRUE)
  }
  else {
    base_conn <- rgcam::localDBConn(gcam_dir, db_name)
    
    land_alloc_query <- '<query title="LUC emissions by region">
                <axis1 name="LandLeaf">LandLeaf</axis1>
                <axis2 name="Year">land-use-change-emission[@year]</axis2>
                <xPath buildList="true" dataName="land-use-change-emission" group="false" sumAll="true">/LandNode[@name=\'root\' or @type=\'LandNode\' (:collapse:)]//
                land-use-change-emission[@year&gt;1970]/text()</xPath>
                <comments/>
            </query>'
    
    new.proj <- rgcam::addSingleQuery(base_conn, "new.proj", "LUC_R", land_alloc_query, c(scenario), clobber=TRUE)
    
    gcam_land_alloc <- rgcam::getQuery(new.proj, "LUC_R")
   # write.csv(gcam_land_alloc, file=filename, row.names = FALSE)
  }
  
  return(gcam_land_alloc)
}


luc_R<- get_gcam_luc_emissR(db_name = 'database_basexdbGCAM',
                                 gcam_dir = 'data/pic_hector_ini',
                               scenario = 'GCAM')

ggplot(luc_R %>% filter(landleaf == 'Pasture_MissouriR', region == 'USA', year <=2015)) +
    geom_line(mapping = aes(x=year, y=value, color = scenario)) +
    ylab('MtC/yr')+
    ggtitle('Pasture_MissouriR GCAM output LUC emissions')

ggplot(luc_R %>% 
           group_by(Units, scenario, year) %>%
           summarize(value = sum( value)) %>%
           ungroup %>% 
           filter(year<=2015)) +
    geom_point(mapping = aes(x=year, y=value, color = scenario)) +
    ylab('MtC/yr')+
    ggtitle('Global aggregate GCAM output LUC emissions') +
    geom_line(data = gcam_emiss %>% filter(Date >= 1975, Date <= 2015),
              mapping = aes(x=Date, y=luc_emissions*1e3), color = 'black')




```

# Plot NBP data

```{r}
gcp_data %>%
  select(year, scenario, nbp, Units) %>%
    select(year, value=nbp, units=Units) %>%
    mutate(variable = 'NBP',
           scenario ="GCP",
           value = 0.001*value,
           units = 'PgC/year'
           ) %>% 
  bind_rows(out) ->
  out2


ggplot(out2 %>% filter(year <= 2021)) +
    geom_line(mapping = aes(x=year,y=value, colour=scenario)) +
    geom_line(data= (gcp_data %>%
                         select(year, scenario, nbp_raw, Units) %>%
                         select(year, value=nbp_raw, units=Units) %>%
                         mutate(variable = 'NBP_raw',
                                scenario ="GCP_raw",
                                value = 0.001*value,
                                units = 'PgC/year'
                                )),
              mapping = aes(x=year, y=value), color = 'grey', alpha = 0.5) +
    ggtitle('gray is raw GCP')

rm(out)
rm(out2)
rm(gcp_data_dawn)
rm(luc_R)

```



# Test Hector NBP constraints.

The 0-level test for whether the NBP constraint works is if you can do a Hector run,
extract the NBP from that run, use that NBP as a constraint for a new Hector run,
and get the same results. 

This is trickier than it sounds, due to uninformative errors triggered in `fluxpool.hpp`:
```
inline void fluxpool::set(double v, unit_types u, bool track = false,
                          string pool_name = "test") {
  name = pool_name;
  if (v < 0) {
    H_ASSERT(v >= 0, "Flux and pool values may not be negative in 2 " + name);
  }
 ```
  - even updating the default pool string name from "?", rebuilding hector, doing devtools::load_all 
  here so it's updated, the resulting error is still 
  "Flux and pool values may not be negative in 2 ?"
  - added the 2 to the error statement so I knew Rstudio was seeing update in C++ code'.
  
  **Solution Part 1**: only use an NBP constraint with positive values.
  
  - In practice, this just means only using years >1970 or so as the constraint. 
  
  - for GCP, depending on how you smooth it, this can be 1972. But if you try to use
  1972 on with hector data, need to figure out a different diffusivity. very dumb.
  
  - This led to some different errors, sometimes, that made me think I was on the right 
  track but still ultimately gave the same flux values may not be negative error most of
  the time.
  
  **Solution Part 2**: Lower the ocean heat diffusivity from its default value 
  of 2.38 cm2/s to 2.31 cm2/s (for a 245).
  
  - ACS had run some NBP constraints a year+ ago and they were NOT as finicky to get to solve,
  but that version of hector had different beta, q10, and diffusivity.
  
  - the old (1.16) vs new value of diffusivity was the biggest difference (new was about 
  double old), so started at 2.38 and just started incremementing lower until the
  constraint solved. 
  
  - definitely had some runs with 2.34 that solved but can't replicate. I _think_ this
  is not a real instability in hector code but is instead user error - in rstudio,
  you can't cmd+enter a bunch of `rhector` function calls together - some end up 
  kind of skipped because the `newcore` and `setvar` functions seem to take an 
  extra moment and need to be run on their own before proceeding?
  
  - but also only sometimes. Seems to always be fine when knitting at least.
  

  
## functions 

- handful of steps with the above, so make a function instead of copying
and pasting every time. 

- adjusting ocean heat diffusivity to 2.31 cm2/s

```{r}
adjust_hector_run <- function(initial_ini,
                              scen_name,
                              diffusivity = 2.31){
    
    rcp <- initial_ini
    scenario_file <- paste0("input/hector_",rcp,".ini")
    ini_file <- system.file(scenario_file, package="hector") 
    
    core <- hector::newcore(ini_file, suppresslogging = FALSE, name=scen_name)
    hector::run(core,runtodate = 2100)
    
    setvar(core, NA, DIFFUSIVITY(), diffusivity, "cm2/s") # default 2.38
    print(fetchvars(core, NA, DIFFUSIVITY()))
    
    hector::run(core,runtodate = 2100)
    
    return(core)
}

output_extractor <- function(core){
    fetchvars(core,
              dates=1750:2100,
              vars=c(GLOBAL_TAS(),
                     CONCENTRATIONS_CO2(), 
                     NBP(),
                     LL_OCEAN_UPTAKE(),
                     HL_OCEAN_UPTAKE(),
                     SOIL_C(),
                     VEG_C()))  %>%
        mutate(variable = if_else( variable == 'NBP', 'A.NBP',
                               if_else(variable == 'CO2_concentration', 'B.CO2_concentration',
                                       if_else(variable == 'global_tas', 'C.global_tas',
                                               if_else(variable == 'LL_ocean_uptake', 'F.LL_ocean_uptake',
                                                       if_else(variable == 'HL_ocean_uptake', 'G.HL_ocean_uptake',
                                                               if_else( variable == 'soil_c', 'D.soil_c',
                                                                        if_else(variable == 'veg_c', 'E.veg_c',
                                                                                variable)))))))) %>%
    mutate(variable = paste0(variable, '~', units)) 
    
}

```
  
  
## Check effect of ocean param change


```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Default hector
rcp <- "ssp245"
scenario_file <- paste0("input/hector_",rcp,".ini")
ini_file245 <- system.file(scenario_file, package="hector") 

core245 <- hector::newcore(ini_file245, name = 'ssp245_default')
hector::run(core245,runtodate = 2100)

# Core with adjusted params that work for constraint
#reset(core_test)
core_test <- adjust_hector_run(initial_ini = 'ssp245',
                                scen_name = 'ssp245_diff2.31')
hector::run(core_test,runtodate = 2100)

# extract outputs
bind_rows(output_extractor(core245),
          output_extractor(core_test)) ->
    plot_out

ggplot(plot_out) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    ggtitle('Effect of diffusivity 2.31 cm2/s (old = 2.38)')


```

- note visible HL_ocean_uptake potential instability in ~2070, otherwise differences are: 

```{r}

plot_out %>%
    filter(scenario == 'ssp245_default') %>%
    rename(ssp245_default = value) %>%
    select(-scenario) %>%
    left_join(plot_out %>%
                  filter(scenario == 'ssp245_diff2.31') %>%
                  rename(ssp245_diff2.31 = value) %>%
                  select(-scenario),
              by = c('year', 'variable', 'units') ) %>%
    group_by(variable, units) %>%
    summarize(maxdiff = max(abs(ssp245_default-ssp245_diff2.31)),
              maxnormdiff = max(abs(ssp245_default-ssp245_diff2.31)) /max(abs(ssp245_default))) %>%
    ungroup %>%
    knitr::kable()
```


- take a look at ocean in more detail

```{r, fig.width = 8, fig.height=6, units = 'in'}
ggplot(plot_out %>% filter(grepl('ocean', variable))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    ggtitle('Effect of diffusivity 2.31 cm2/s (old = 2.38)')
```


- So the potential instability in the ocean uptake is present for both values
of diffusivity


So not surprisingly based on a lot of other things we have seen over the last
couple years with hector, the **ocean** is the part that needs maintenance.

- good to know diffusivity is a lever. Will do some sensitivity tests further
down sweeping out different diffusivity values vs different magnitudes of NBP
(will explain more there).


- zoom in some more on terrestrial carbon quantities


```{r, fig.width = 8, fig.height=9, units = 'in'}
ggplot(plot_out %>% filter(grepl('NBP', variable) | grepl('veg', variable) | grepl('soil', variable)) )+
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=3) +
    ggtitle('Effect of diffusivity 2.31 cm2/s (old = 2.38)')
```

- nothing obvious stands out.

**So from this point, all Hector runs will be done with 2.31cm2/s for **
**diffusivity so the NBP constraints will actually run without running into **
**negative flux pools.**

## 0-level test: Hector 245 1970-2100 constraint

If we extract the entire nbp trajectory from a hector run and make it the 
constraint for a run with otherwise identical settings, do we get identical 
results?

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# clean up some variables
rm(core_test)
rm(core245)
rm(plot_out)

# initialize a holder of outputs 
output_holder <- list()

# Do the run to generate the constraing
core <- adjust_hector_run(initial_ini = 'ssp245',
                                scen_name = 'ssp245_gen')

output_holder[['ssp245_gen']] <- output_extractor(core)
rm(core)


# Extract Constraint 
output_holder[['ssp245_gen']] %>% 
    filter(grepl('NBP', variable),
           year >= 1970,
           year<= 2100) ->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp245',
                          scen_name = 'ssp245_1970~2100')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")

hector::run(core,runtodate = 2100)

output_holder[['ssp245_1970~2100']] <- output_extractor(core)
rm(core)

ggplot(do.call(rbind, output_holder) %>% filter(grepl('245', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    ggtitle('testing NBP constraint SSP245')
```



- Previously only compared NBP before and after applying constraint.

- clear from looking at these additional quantities, it's not working correctly.

- differences in soil and veg carbon are possibly a bit weird (depending on how 
constraint implemented in code). But in theory, calculations from the land box
don't go anywhere when there is an NBP constraint, so a difference is ok as long 
as the land calculations don't co anywhere.

- But the ocean uptakes differing as well suggests the land calculations ARE 
going somewhere and being used instead of the constraint. 

- **HYPOTHESIS** in code, the NBP constraint is overwriting some values in some 
places (which is why NBP constraint returns identical) but probably not in all
of the places it should. 

- So constraint being on = land box evolves differently, with lower soil and veg
carbon stocks. Lower land carbon stocks (soil especially) means lower ocean 
uptake in reaction? **is that right directions?**

```{r, echo = FALSE}
output_holder[['ssp245_gen']] %>%
    filter(scenario == 'ssp245_gen') %>%
    rename(ssp245_gen = value) %>%
    select(-scenario) %>%
    left_join(output_holder[['ssp245_1970~2100']]  %>%
                  filter(scenario == 'ssp245_1970~2100') %>%
                  rename(`ssp245_1970~2100` = value) %>%
                  select(-scenario),
              by = c('year', 'variable', 'units') ) %>%
    group_by(variable, units) %>%
    summarize(maxdiff = max(abs(ssp245_gen-`ssp245_1970~2100`)),
              maxnormdiff = max(abs(ssp245_gen-`ssp245_1970~2100`)) /max(abs(ssp245_gen))) %>%
    ungroup %>%
    knitr::kable(caption = 'SSP245 NBP constraint testing')
```

## 0-level test: Hector 126 1970-2100 constraint

Know ssp245 can be weird (github issue), so double check other scenarios

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Do the run to generate the constraing
core <- adjust_hector_run(initial_ini = 'ssp126',
                                scen_name = 'ssp126_gen')

output_holder[['ssp126_gen']] <- output_extractor(core)
rm(core)


# Extract Constraint 
output_holder[['ssp126_gen']] %>% 
    filter(grepl('NBP', variable),
           year >= 1970,
           year<= 2100) ->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp126',
                          scen_name = 'ssp126_1970~2100')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")

hector::run(core,runtodate = 2100)

output_holder[['ssp126_1970~2100']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(grepl('126', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    ggtitle('testing NBP constraint SSP126')
```

- so not just a 245 quirk

## 0-level test: Hector 585 1970-2100 constraint

```{r, fig.width = 14, fig.height= 8, units = 'in'}

# Do the run to generate the constraing
core <- adjust_hector_run(initial_ini = 'ssp585',
                                scen_name = 'ssp585_gen')

output_holder[['ssp585_gen']] <- output_extractor(core)
rm(core)


# Extract Constraint 
output_holder[['ssp585_gen']] %>% 
    filter(grepl('NBP', variable),
           year >= 1970,
           year<= 2100) ->
    nbp_constrainer


# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp585',
                          scen_name = 'ssp585_1970~2100')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")

hector::run(core,runtodate = 2100)

output_holder[['ssp585_1970~2100']] <- output_extractor(core)
rm(core)
 

ggplot(do.call(rbind, output_holder) %>% filter(grepl('585', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    ggtitle('testing NBP constraint SSP585')
```



# More constraints

## hector 245 1970-2021 constraint

- Seems useful to understand what happens when you just constrain the (usable)
historical period.

- usable in the sense that need NBP constraint values not to be negative, so
years > 1970.

- cutting at 2021 because that's the last year in the GCP data I have.


```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Constraint with updated params
output_holder[['ssp245_gen']] %>% 
    filter(grepl('NBP', variable),
           year >= 1970,
           year<= 2021) ->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp245',
                          scen_name = 'ssp245_1970~2021')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")

hector::run(core,runtodate = 2100)

output_holder[['ssp245_1970~2021']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(grepl('245', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+
    ggtitle('testing NBP constraint SSP245')
```

- By terminating the constraint in 2021, all variables are able to drift closer
to their default hector behavior.

- NOTE the abrupt jump in NBP when the constraint ceases. **HYPOTHESIS** The 
background land calculations going on while the constraint is in place are 
immediately what kicks in at the end of the constraint, rather than the 
constraint value.

- In 2020, background calculation produces lower carbon stocks in land = abrupt
jump in land sink? can't tell if that's right but 
**blue vs green and red vs green curve comparison in this figure is the key**
to figuring it out, I think.


## GCP NBP constraint 1972-2021

A few years in the GCP data from 1970-1980 have nbp<0.

This seems to cause the NBP constraint Hector actually sees to remain at 0,
leading to a huge rebound spike when the constraint ends in 2021.

Just droping the specific years with negative nbp causes Hector to fill in 0s for
those years, leading to a rebound at each of these years (not shown).

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Run with GCP NBP
gcp_data %>% 
    filter(year >= 1972,
           year<= 2021) %>%
    #filter(nbp>0) %>%
    mutate(value = 0.001*nbp,
           Units = "Pg C/yr")->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp245',
                          scen_name = 'ssp245_GCP1972~2021')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")


hector::run(core,runtodate = 2100)

output_holder[['ssp245_GCP1972~2021']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(grepl('245', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+
    ggtitle('testing NBP constraint SSP245')

```

- Near end of GCP constaint (~2015), NBP is almost twice as large as in the 
hector default. This leads to a rebound dip.

## 245 runs magnified

```{r, fig.width = 14, fig.height= 8, units = 'in'}
ggplot(do.call(rbind, output_holder) %>% filter(grepl('245', scenario), year >= 1965, year <=2050)) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+ 
    ggtitle('testing NBP constraint SSP245')

```

## hector 585 1970-2021 constraint

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Constraint with updated params
output_holder[['ssp585_gen']] %>% 
    filter(grepl('NBP', variable),
           year >= 1970,
           year<= 2021) ->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp585',
                          scen_name = 'ssp585_1970~2021')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")

hector::run(core,runtodate = 2100)

output_holder[['ssp585_1970~2021']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(grepl('585', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+
    ggtitle('testing NBP constraint SSP585')
```

## GCP 585 1972-2021

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Run with GCP NBP
gcp_data %>% 
    filter(year >= 1972,
           year<= 2021) %>%
    #filter(nbp>0) %>%
    mutate(value = 0.001*nbp,
           Units = "Pg C/yr")->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp585',
                          scen_name = 'ssp585_GCP1972~2021')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")


hector::run(core,runtodate = 2100)

output_holder[['ssp585_GCP1972~2021']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(grepl('585', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+
    ggtitle('testing NBP constraint SSP585')

```

## GCP 585 1972-2000

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Run with GCP NBP
gcp_data %>% 
    filter(year >= 1972,
           year<= 2000) %>%
    #filter(nbp>0) %>%
    mutate(value = 0.001*nbp,
           Units = "Pg C/yr")->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp585',
                          scen_name = 'ssp585_GCP1972~2000')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")


hector::run(core,runtodate = 2100)

output_holder[['ssp585_GCP1972~2000']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(grepl('585', scenario))) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+ 
    geom_vline(xintercept = 2021, size = 0.1, color = 'grey')+ 
    ggtitle('testing NBP constraint SSP585')

```

## 585 runs magnified

```{r, fig.width = 14, fig.height= 8, units = 'in'}
ggplot(do.call(rbind, output_holder) %>% filter(grepl('585', scenario), year >= 1965, year <=2050)) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+ 
    geom_vline(xintercept = 2021, size = 0.1, color = 'grey')+ 
    ggtitle('testing NBP constraint SSP585')

```

## 126 1970-2021



# Constraints across scenarios

```{r, fig.width = 14, fig.height= 8, units = 'in'}
# Constraint with updated params
output_holder[['ssp126_gen']] %>% 
    filter(grepl('NBP', variable),
           year >= 1970,
           year<= 2021) ->
    nbp_constrainer

# Set up core for constraint, set constraint, run wtih constraint
core <- adjust_hector_run(initial_ini = 'ssp126',
                          scen_name = 'ssp126_1970~2021')
setvar(core, nbp_constrainer$year, NBP_CONSTRAIN(), nbp_constrainer$value, "Pg C/yr")

hector::run(core,runtodate = 2100)

output_holder[['ssp126_1970~2021']] <- output_extractor(core)
rm(core)


ggplot(do.call(rbind, output_holder) %>% filter(!grepl('GCP', scenario), year >= 1965, year <=2050)) +
    geom_line(mapping = aes(x=year, y = value, color = scenario, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=2) +
    geom_vline(xintercept = 2021, size = 0.2)+
    ggtitle('testing NBP constraint')
```


# Conclusions

1. NBP constraint is not properly passing/talking to all other parts of Hector.

- So my guess of what’s happening, just based on the plots, is the land 
calculations still run in the background and the NBP constraint is supposed to 
just ignore them. But somewhere, the land calculations aren’t actually being 
ignored and the ocean uptake reacts to them. 

- So I think Atm C is getting the nbp constraint for land, but also the ocean
differences reacting to background land caluclations insteadof NBP and that’s 
what makes AtmC a little different?

- No idea:

A. Where in the code the land calculations that should be ignored are getting 
passed on to anything

B. Why those background land calculations are different


IDEA: check PR that added NBP to track down code changes relevant? Or strip out
CO2 tracking first?

There is also:

2. HL ocean uptake plots also suggest potential for numerical instability going
on there.


# DISREGARD from here other tests

Can update the below when NBP constraint actually mechanically works.

all of above was just trying to get NBP cosntraint to run at all.

Need:

1. to make sure that for an ordered set of NBP constraints, T and CO2 should
be following sensible order

2. sensitivity on magnitude of constraint vs diffusivity


## Ordered constraints 1970-2021 and T, CO2

keep it simple  - couple multiples of 245 NBP with 2.31

```{r,eval=FALSE, fig.width = 14, fig.height = 5, units = 'in'}

# Get constraint:
core_constrain <- hector::newcore(ini_file245, name = '245_diff2.31_generate')
setvar(core_constrain, NA, DIFFUSIVITY(), 2.31, "cm2/s") # default 2.38


hector::run(core_constrain,runtodate = 2050)

nbp <- fetchvars(core_constrain, 1965:2050, NBP())

out  <-fetchvars(core_constrain,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                                       CONCENTRATIONS_CO2(), 
                                                       NBP(),
                                                       LL_OCEAN_UPTAKE(),
                                                       HL_OCEAN_UPTAKE())) %>%
    mutate(k=1)


# Constraint with updated params
nbp %>% 
    filter(scenario == '245_diff2.31_generate',
           year >= 1970,
           year<= 2021) ->
    nbp_constrainer


for (k in c(0.5, 1, 2, 5, 8)){
    core_k <- hector::newcore(ini_file245, name = paste0('245_diff2.31_constrain_k',k))
    setvar(core_k, NA, DIFFUSIVITY(), 2.31, "cm2/s")
    
    setvar(core_k, nbp_constrainer$year, NBP_CONSTRAIN(), k*nbp_constrainer$value, "Pg C/yr")
    
    hector::run(core_k,runtodate = 2050)

    
    fetchvars(core_k,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                            CONCENTRATIONS_CO2(), 
                                            NBP(),
                                            LL_OCEAN_UPTAKE(),
                                            HL_OCEAN_UPTAKE())) %>%
        mutate(k=k) %>%
        bind_rows(out) -> 
        out
    rm(core_k)
}


# Order the variables for faceting
out %>%
    mutate(variable = if_else( variable == 'NBP', 'A.NBP',
                               if_else(variable == 'CO2_concentration', 'B.CO2_concentration',
                                       if_else(variable == 'global_tas', 'C.global_tas',
                                               if_else(variable == 'LL_ocean_uptake', 'D.LL_ocean_uptake',
                                                       if_else(variable == 'HL_ocean_uptake', 'E.HL_ocean_uptake',
                                                               variable)))))) %>%
    mutate(variable = paste0(variable, '~', units)) ->
    out2

ggplot(out2) +
    geom_line(mapping = aes(x=year, y = value, color = k, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=1) +
    geom_vline(xintercept = 2021, size = 0.3) +
    scale_color_continuous() +
    ggtitle('diffusivity 2.31 cm2/s')

```

## Ordered constraints 1970-2050 and T, CO2

keep it simple  - couple multiples of 245 NBP with 2.31

```{r, eval=FALSE, fig.width = 14, fig.height = 5, units = 'in'}

# Get constraint:
nbp <- fetchvars(core_constrain, 1965:2050, NBP())

out  <-fetchvars(core_constrain,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                                       CONCENTRATIONS_CO2(), 
                                                       NBP(),
                                                       LL_OCEAN_UPTAKE(),
                                                       HL_OCEAN_UPTAKE())) %>%
    mutate(k=1)


# Constraint with updated params
nbp %>% 
    filter(scenario == '245_diff2.31_generate',
           year >= 1970,
           year<= 2050) ->
    nbp_constrainer


for (k in c(0.5, 1, 2, 5)){
    core_k <- hector::newcore(ini_file245, name = paste0('245_diff2.31_constrain_k',k))
    setvar(core_k, NA, DIFFUSIVITY(), 2.31, "cm2/s")
    
    setvar(core_k, nbp_constrainer$year, NBP_CONSTRAIN(), k*nbp_constrainer$value, "Pg C/yr")
    
    hector::run(core_k,runtodate = 2050)

    
    fetchvars(core_k,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                            CONCENTRATIONS_CO2(), 
                                            NBP(),
                                            LL_OCEAN_UPTAKE(),
                                            HL_OCEAN_UPTAKE())) %>%
        mutate(k=k) %>%
        bind_rows(out) -> 
        out
    rm(core_k)
}


# Order the variables for faceting
out %>%
    mutate(variable = if_else( variable == 'NBP', 'A.NBP',
                               if_else(variable == 'CO2_concentration', 'B.CO2_concentration',
                                       if_else(variable == 'global_tas', 'C.global_tas',
                                               if_else(variable == 'LL_ocean_uptake', 'D.LL_ocean_uptake',
                                                       if_else(variable == 'HL_ocean_uptake', 'E.HL_ocean_uptake',
                                                               variable)))))) %>%
    mutate(variable = paste0(variable, '~', units)) ->
    out2

ggplot(out2) +
    geom_line(mapping = aes(x=year, y = value, color = k, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=1) +
    # geom_vline(xintercept = 2021, size = 0.3) +
    scale_color_continuous() +
    ggtitle('diffusivity 2.31 cm2/s')

```



## lower diffusivity 1970-2021

use 1.16, show that nbp/co2/temp don't behave the way they should.


```{r,eval=FALSE, fig.width = 14, fig.height = 5, units = 'in'}

# Get constraint:
core_constrain <- hector::newcore(ini_file245, name = '245_diff1.16_generate')
setvar(core_constrain, NA, DIFFUSIVITY(), 1.16, "cm2/s") # default 2.38


hector::run(core_constrain,runtodate = 2050)

nbp <- fetchvars(core_constrain, 1965:2050, NBP())

out  <-fetchvars(core_constrain,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                                       CONCENTRATIONS_CO2(), 
                                                       NBP(),
                                                       LL_OCEAN_UPTAKE(),
                                                       HL_OCEAN_UPTAKE())) %>%
    mutate(k=1)


# Constraint with updated params
nbp %>% 
    filter(scenario == '245_diff1.16_generate',
           year >= 1970,
           year<= 2021) ->
    nbp_constrainer


for (k in c(0.5, 1, 2, 5, 8)){
    core_k <- hector::newcore(ini_file245, name = paste0('245_diff1.16_constrain_k',k))
    setvar(core_k, NA, DIFFUSIVITY(), 1.16, "cm2/s")
    
    setvar(core_k, nbp_constrainer$year, NBP_CONSTRAIN(), k*nbp_constrainer$value, "Pg C/yr")
    
    hector::run(core_k,runtodate = 2050)

    
    fetchvars(core_k,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                            CONCENTRATIONS_CO2(), 
                                            NBP(),
                                            LL_OCEAN_UPTAKE(),
                                            HL_OCEAN_UPTAKE())) %>%
        mutate(k=k) %>%
        bind_rows(out) -> 
        out
    rm(core_k)
}


# Order the variables for faceting
out %>%
    mutate(variable = if_else( variable == 'NBP', 'A.NBP',
                               if_else(variable == 'CO2_concentration', 'B.CO2_concentration',
                                       if_else(variable == 'global_tas', 'C.global_tas',
                                               if_else(variable == 'LL_ocean_uptake', 'D.LL_ocean_uptake',
                                                       if_else(variable == 'HL_ocean_uptake', 'E.HL_ocean_uptake',
                                                               variable)))))) %>%
    mutate(variable = paste0(variable, '~', units)) ->
    out2

ggplot(out2) +
    geom_line(mapping = aes(x=year, y = value, color = k, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=1) +
    geom_vline(xintercept = 2021, size = 0.3) +
    scale_color_continuous() +
    ggtitle('diffusivity 1.16 cm2/s')


```


## lower diffusivity 1970-2050

use 1.16, show that nbp/co2/temp don't behave the way they should.


```{r, eval=FALSE, fig.width = 14, fig.height = 5, units = 'in'}

# Get constraint:
nbp <- fetchvars(core_constrain, 1965:2050, NBP())

out  <-fetchvars(core_constrain,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                                       CONCENTRATIONS_CO2(), 
                                                       NBP(),
                                                       LL_OCEAN_UPTAKE(),
                                                       HL_OCEAN_UPTAKE())) %>%
    mutate(k=1)


# Constraint with updated params
nbp %>% 
    filter(scenario == '245_diff1.16_generate',
           year >= 1970,
           year<= 2050) ->
    nbp_constrainer


for (k in c(0.5, 1, 2, 5)){
    core_k <- hector::newcore(ini_file245, name = paste0('245_diff1.16_constrain_k',k))
    setvar(core_k, NA, DIFFUSIVITY(), 1.16, "cm2/s")
    
    setvar(core_k, nbp_constrainer$year, NBP_CONSTRAIN(), k*nbp_constrainer$value, "Pg C/yr")
    
    hector::run(core_k,runtodate = 2050)

    
    fetchvars(core_k,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                            CONCENTRATIONS_CO2(), 
                                            NBP(),
                                            LL_OCEAN_UPTAKE(),
                                            HL_OCEAN_UPTAKE())) %>%
        mutate(k=k) %>%
        bind_rows(out) -> 
        out
    rm(core_k)
}


# Order the variables for faceting
out %>%
    mutate(variable = if_else( variable == 'NBP', 'A.NBP',
                               if_else(variable == 'CO2_concentration', 'B.CO2_concentration',
                                       if_else(variable == 'global_tas', 'C.global_tas',
                                               if_else(variable == 'LL_ocean_uptake', 'D.LL_ocean_uptake',
                                                       if_else(variable == 'HL_ocean_uptake', 'E.HL_ocean_uptake',
                                                               variable)))))) %>%
    mutate(variable = paste0(variable, '~', units)) ->
    out2

ggplot(out2) +
    geom_line(mapping = aes(x=year, y = value, color = k, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=1) +
    geom_vline(xintercept = 2021, size = 0.3) +
    scale_color_continuous() +
    ggtitle('diffusivity 1.16 cm2/s')



```


## replicate NBP-T-C issue 

```{r,eval=FALSE}

# GCP
gcp_data %>% 
    filter(year >= 1972,
           year<= 2021) %>%
    #filter(nbp>0) %>%
    mutate(nbp = 0.001*nbp,
           Units = "Pg C/yr")->
    nbp_constrainer


coreGCP <- hector::newcore(ini_file245, name = 'GCP_diff2.31_constraint_1972~2021')
# setvar(coreGCP, NA, BETA(), 0.55, "(unitless)")
# setvar(coreGCP, NA, Q10_RH(), 2.2, "(unitless)") 
setvar(coreGCP, NA, DIFFUSIVITY(), 1.16, "cm2/s") 

setvar(coreGCP,nbp_constrainer$year,"NBP_constrain",nbp_constrainer$nbp,"Pg C/yr")

hector::run(coreGCP,runtodate = 2050)


out  <-fetchvars(coreGCP, dates=1965:2050,vars=c(GLOBAL_TAS(),
                                                       CONCENTRATIONS_CO2(), 
                                                       NBP(),
                                                       LL_OCEAN_UPTAKE(),
                                                       HL_OCEAN_UPTAKE())) %>%
    mutate(k=1)


for (k in c(2, 6)){
    core_k <- hector::newcore(ini_file245, name = paste0('245_k',k))
    # setvar(coreGCP, NA, BETA(), 0.55, "(unitless)") # have to be consistent with above
    # setvar(coreGCP, NA, Q10_RH(),2.2, "(unitless)") # have to be consistent with above
    setvar(core_k, NA, DIFFUSIVITY(), 1.16, "cm2/s")
    
    setvar(core_k, nbp_constrainer$year, NBP_CONSTRAIN(), k*nbp_constrainer$nbp, "Pg C/yr")
    
    hector::run(core_k,runtodate = 2050)

    
    fetchvars(core_k,dates=1965:2050,vars=c(GLOBAL_TAS(),
                                            CONCENTRATIONS_CO2(), 
                                            NBP(),
                                            LL_OCEAN_UPTAKE(),
                                            HL_OCEAN_UPTAKE())) %>%
        mutate(k=k) %>%
        bind_rows(out) -> 
        out
    rm(core_k)
}


# Order the variables for faceting
out %>%
    mutate(variable = if_else( variable == 'NBP', 'A.NBP',
                               if_else(variable == 'CO2_concentration', 'B.CO2_concentration',
                                       if_else(variable == 'global_tas', 'C.global_tas',
                                               if_else(variable == 'LL_ocean_uptake', 'D.LL_ocean_uptake',
                                                       if_else(variable == 'HL_ocean_uptake', 'E.HL_ocean_uptake',
                                                               variable)))))) %>%
    mutate(variable = paste0(variable, '~', units)) ->
    out2

ggplot(out2 %>% filter(year <= 2000)) +
    geom_line(mapping = aes(x=year, y = value, color = k, linetype = scenario)) +
    facet_wrap(~variable, scales = 'free_y', nrow=1) +
    geom_vline(xintercept = 1994, size = 0.3) +
    scale_color_continuous() #+
    #ggtitle('diffusivity 1.16 cm2/s, beta=0.55, q10=2.2 \n just changing diff is not enough')




```
diff: 1.16, beta:.55, q10: 2.2

can't replicate but ocean uptake in 1993-1995 interesting: in default, both 
LL and HL ocean are a valley at the same time as NBP valley.

But when that NBP valley is made more extreme, HL and LL become peaks


diff:2.31, beta:0.53, q10:1.76


TODO have plots for both parameterization, not just toggle in code

ALSO TODO: why changing beta and q10 changing plots for same diffusivity (double check side by side)
- have to use diff 1.16 to solve with both sets of beta/q10 but identical as should be (think)


- make a copy of the old notebook and see if can re-generate there with old params and new hector.


## sweep diffusivity vs gcp magnitude



# test doing one year at a time (like DW work)

is there a rebound when feeding on next time step

ALSO double check gcamlandc - is it passing emissions/land (spikes) or stock/land
stock/land might have spikes too, since dividing by land tricky at the changes, esp
with lag 
